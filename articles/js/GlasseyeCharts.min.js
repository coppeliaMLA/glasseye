function barchart(t,e,a){var r=function(t){for(processed_data=[],i=0;i<t.value.length;i++)data_item={label:t.label[i],value:+t.value[i]},processed_data.push(data_item);return processed_data},n=function(t,e,a){var r=[],n=[];void 0===t[0].group?(r=t.map(function(t){return t.label}),n=t.map(function(t){return t.value})):(r=t.map(function(t){return t.group}),n=t.map(function(t){return t.values.map(function(t){return t.y1})}),n=[].concat.apply([],n));var i=[create_scale(r,d3.scale.ordinal()),create_scale(n,d3.scale.linear())],o=new BarChart(t,e,a,["label","value"],i);o.add_svg().add_grid().add_bars().grumpy("bayesian")};build_chart(t,e,a,void 0,group_label_value_parser,r,n)}function create_scale(t,e,a){var r=d3.min(t),n=d3.max(t),i=n-r,o=i/n,s=e;if("function"==typeof e.rangePoints){s.domain(t);var l="ordinal"}else if("number"==typeof t[0]){.25>o||0>r?s.domain([r-.1*i,n+.1*i]).nice:s.domain([0,n+.1*i]).nice;var l="linear"}else if(s.domain([r,n]).nice,"Date"===t[0].constructor.name)var l="datetime";else var l="nonlinear";return{scale_func:s,scale_type:l}}function build_chart(t,e,a,r,n,i,o){if("object"==typeof t){var s=i(t);o(s,e,a,r)}else d3.csv(t,function(t,i){var s=n(i);o(s,e,a,r)})}function add_legend(t,e,a,r){var n=t.selectAll(".legend_item").data(r).enter().append("g").attr("class","legend_item").attr("transform","translate("+e+","+a+")");n.append("rect").attr("width",10).attr("height",10).attr("class",function(t){return"legend_block "+t["class"]}).attr("x",10).attr("y",function(t,e){return 20*e}).attr("fill",function(t,e){return t.colour}),n.append("text").attr("x",27).attr("y",function(t,e){return 8+20*e}).text(function(t){return t.label})}function wrap(t,e){t.each(function(){for(var t,a=d3.select(this),r=a.text().split(/\s+/).reverse(),n=[],i=0,o=1.1,s=a.attr("y"),l=parseFloat(a.attr("dy")),c=a.text(null).append("tspan").attr("x",0).attr("y",s).attr("dy",l+"em");t=r.pop();)n.push(t),c.text(n.join(" ")),c.node().getComputedTextLength()>e&&(n.pop(),c.text(n.join(" ")),n=[t],c=a.append("tspan").attr("x",0).attr("y",s).attr("dy",++i*o+l+"em").text(t))})}function abbrev(t,e){return t.length>e&&(t=t.substring(0,e-3)+"..."),t}function minmax_across_groups(t,e){return y_values=t.map(function(t){return t.values.map(function(t){return t.variable===e?t.value:void 0})}),y_values=[].concat.apply([],y_values),[d3.min(y_values),d3.max(y_values)]}function create_class_label(t,e){return t+"_"+e.replace(/[.,\/#!$%\^&\*;:{}=+\-_`~()]/g,"").replace(" ","")}function donut(t,e,a){var r=function(t){for(processed_data=[],i=0;i<t.values.length;i++)data_item={label:t.labels[i],value:+t.values[i]},processed_data.push(data_item);return processed_data},n=function(t){return t},o=function(t,e,a){var r=new Donut(t,e,a);r.add_svg().add_donut()};build_chart(t,e,a,void 0,n,r,o)}function force(t,e,a){var r=function(t){return t},n=function(t){return t},i=function(t,e,a){var r=new Force(t,e,a);r.add_svg().add_force()};build_chart(t,e,a,void 0,n,r,i)}function gantt(t,e,a){var r=function(t){var e=d3.time.format("%d/%m/%Y").parse;return t.forEach(function(t){t.start=e(t.start),t.end=e(t.end)}),t.sort(function(t,e){return e.start-t.start}),t},n=function(t){},i=function(t,e,a){var r=t.map(function(t){return t.start}),n=t.map(function(t){return t.end}),i=r.concat(n),o=t.map(function(t){return t.task}),s=[create_scale(i,d3.time.scale()),create_scale(o,d3.scale.ordinal())],l=new Gantt(t,e,a,s);l.add_svg().add_grid().add_tasks()};build_chart(t,e,a,void 0,n,r,i)}function lineplot(t,e,a,r){var n=function(t){var e=[];for(i=0;i<t.x.length;i++)data_item={x:+t.x[i],y:+t.y[i]},e.push(data_item);return e},o=function(t){var e=t.map(function(t){return{x:+t.x,y:+t.y}});return e},s=function(t,e,a,r){var n=t.map(function(t){return t.x}),i=t.map(function(t){return t.y}),o=[create_scale(n,d3.scale.linear()),create_scale(i,d3.scale.linear())],s=new LinePlot(t,e,a,r,o);s.add_svg().add_grid().add_line()};build_chart(t,e,a,r,o,n,s)}function lineplot(t,e,a,r){var n=function(t){var e=[];for(i=0;i<t.x.length;i++)data_item={x:+t.x[i],y:+t.y[i]},e.push(data_item);return e},o=function(t){var e=t.map(function(t){return{x:+t.x,y:+t.y}});return e},s=function(t,e,a,r){var n=t.map(function(t){return t.x}),i=t.map(function(t){return t.y}),o=[create_scale(n,d3.scale.linear()),create_scale(i,d3.scale.linear())],s=new LinePlot(t,e,a,r,o);s.add_svg().add_grid().add_line()};build_chart(t,e,a,r,o,n,s)}function treemap(t,e,a){var r=function(t){return t},n=function(t){},i=function(e,a,r){function r(t){return t.size}function n(t){return 1}function i(t){var e=l/t.dx,a=c/t.dy;u.domain([t.x,t.x+t.dx]),d.domain([t.y,t.y+t.dy]);var r=f.selectAll("g.cell").transition().duration(d3.event.altKey?7500:750).attr("transform",function(t){return"translate("+u(t.x)+","+d(t.y)+")"});r.select("rect").attr("width",function(t){return e*t.dx-1}).attr("height",function(t){return a*t.dy-1}),r.select("text").attr("x",function(t){return e*t.dx/2}).attr("y",function(t){return a*t.dy/2}),s=t,d3.event.stopPropagation()}var o,s,l=300,c=400,u=d3.scale.linear().range([0,l]),d=d3.scale.linear().range([0,c]),h=d3.scale.category20c(),p=d3.layout.treemap().round(!1).size([l,c]).sticky(!0).value(function(t){return t.size}),f=d3.select(a).append("svg:svg").attr("width",l).attr("height",c).append("svg:g").attr("transform","translate(.5,.5)"),s=o=t,m=p.nodes(o).filter(function(t){return!t.children}),_=f.selectAll("g").data(m).enter().append("svg:g").attr("class","cell").attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).on("click",function(t){return i(s==t.parent?o:t.parent)});_.append("svg:rect").attr("width",function(t){return t.dx-1}).attr("height",function(t){return t.dy-1}).style("fill",function(t){return h(t.parent.name)}),_.append("svg:text").attr("x",function(t){return t.dx/2}).attr("y",function(t){return t.dy/2}).attr("dy",".35em").attr("text-anchor","middle").text(function(t){return t.name}),d3.select(window).on("click",function(){i(o)}),d3.select("select").on("change",function(){p.value("size"==this.value?r:n).nodes(o),i(s)})};build_chart(t,e,a,void 0,n,r,i)}function simplot(t,e,a){var r=function(t){},n=function(t){var e=[];t.map(function(t){-1===e.indexOf(t.variation)&&e.push(t.variation)});var a=[];t.map(function(t){-1===a.indexOf(t.sim_num)&&a.push(t.sim_num)});var r=e.map(function(e){return{variation:e,simulations:a.map(function(a){return{simulation:+a,values:t.filter(function(t){return t.variation===e&&t.sim_num===a}).map(function(t){return{value:+t.value,iter:+t.day}})}})}}),n={original_data:t,grouped_data:r,variations:e,simulations:a};return n},i=function(t,e,a){var r=new GlasseyeChart(e,a,{top:20,bottom:20,right:100,left:20});r.add_svg();var n=d3.scale.category20(),i=d3.scale.linear().range([0,r.width]).domain([d3.min(t.original_data,function(t){return+t.day})-10,d3.max(t.original_data,function(t){return+t.day})]),o=d3.scale.linear().range([r.height,0]).domain([d3.min(t.original_data,function(t){return+t.value}),d3.max(t.original_data,function(t){return+t.value})]),s=d3.svg.axis().scale(i).orient("bottom").tickSize(-r.height,0,0),l=d3.svg.axis().scale(o).tickSize(-r.width,0,0).orient("left"),c=r.chart_area;c.append("g").attr("class","chart_grid").attr("transform","translate(0,"+r.height+")").call(s),c.append("g").attr("class","chart_grid").call(l);var u=d3.svg.line().interpolate("linear").x(function(t){return i(t.iter)}).y(function(t){return o(t.value)});t.grouped_data.forEach(function(e,a){function r(){var e=d3.select(this);e.attr("stroke-dasharray",function(t){return t.totalLength+" "+t.totalLength}).attr("stroke-dashoffset",function(t){return t.totalLength}).transition().delay(7e3*a).duration(7e3).ease("linear").attr("stroke-dashoffset",0).transition().duration(7e3*(t.variations.length-1-a)).attr("stroke-dashoffset",0).each("end",r)}var i=c.selectAll(".variations").data(e.simulations).enter().append("g").append("path").attr("class","line").attr("d",function(t){return u(t.values)}).style("stroke",function(t){return n(e.variation)}).attr("opacity",function(t){return-1===t.simulation?1:.1});i.each(function(t){t.totalLength=this.getTotalLength()}).attr("stroke-dasharray",function(t){return t.totalLength+" "+t.totalLength}).attr("stroke-dashoffset",function(t){return t.totalLength}).transition().delay(7e3*a).duration(7e3).ease("linear").attr("stroke-dashoffset",0).transition().duration(7e3*(t.variations.length-1-a)).attr("stroke-dashoffset",0).each("end",r)}),t.variations.length>1&&add_legend(c,r.width+r.margin.left,r.margin.top,t.variations.map(function(t){return{label:t,colour:n(t)}}))};build_chart(t,e,a,void 0,n,r,i)}function dot_plot(t,e,a){var r=650,n=400,i={top:20,right:250,bottom:110,left:30},o=r-i.left-i.right,s=n-i.top-i.bottom,l=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(t){return t.value});d3.csv(t,function(t,a){var c=d3.scale.category10(),u=[];a.map(function(t){-1===u.indexOf(t.group)&&u.push(t.group)});var d=[];a.map(function(t){-1===d.indexOf(t.variable)&&d.push(t.variable)});var h=u.map(function(t){return{group:t,values:a.filter(function(e){return e.group===t}).map(function(t){return{value:+t.value,variable:t.variable}})}}),p=d3.min(a,function(t){return+t.value}),f=d3.max(a,function(t){return+t.value}),m=f-p,_=m/f,v=d3.scale.linear().range([s,0]);.3>_?v.domain([p-.1*m,f+.1*m]).nice:v.domain([0,f]).nice;var g=d3.scale.ordinal().rangePoints([0,o],1).domain(d),y=d3.svg.axis().scale(g).orient("bottom").tickSize(-s,0,0).tickFormat(function(t){return t.length>15?t.substring(0,15)+"..":t}),x=d3.svg.axis().scale(v).tickSize(-o,0,0).orient("left"),b=d3.select(e).append("svg").attr("width",r).attr("height",n).append("g").attr("transform","translate("+i.left+","+i.top+")");b.call(l),b.append("g").attr("class","chart_grid").attr("transform","translate(0,"+s+")").call(y).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy",".15em").attr("transform","rotate(-90)"),b.append("g").attr("class","chart_grid").call(x),h.forEach(function(t,e){b.selectAll(".dot").data(t.values).enter().append("circle").attr("cx",function(t){return g(t.variable)}).attr("cy",function(t){return v(t.value)}).attr("r",6).attr("fill",function(e){return c(t.group)}).attr("opacity",.5).on("mouseover",l.show).on("mouseout",l.hide)}),u.length>1&&add_legend(b,o+i.left,i.top,u.map(function(t){return{label:t,colour:c(t)}}))})}function scatterplot(t,e,a,r){var n=function(t){var e=[];for(i=0;i<t.x.length;i++)data_item={x:+t.x[i],y:+t.y[i]},e.push(data_item);return e},o=function(t){var e=t.map(function(t){return{x:+t.x,y:+t.y,point_label:t.label}});return e},s=function(t,e,a,r){var n=t.map(function(t){return t.x}),i=t.map(function(t){return t.y}),o=[create_scale(n,d3.scale.linear()),create_scale(i,d3.scale.linear())],s=new ScatterPlot(t,e,a,r,o);s.add_svg().add_grid().add_points()};build_chart(t,e,a,r,o,n,s)}function thermometers(t,e,a){var r=function(t){for(processed_data=[],i=0;i<t.value.length;i++)data_item={category:t.category[i],value:+t.value[i]},processed_data.push(data_item);return processed_data},n=function(t){var e=d3.time.format("%d/%m/%Y").parse,a=t.map(function(t){return{category:t.category,filter:t.filter,value:t.value,time:e(t.time)}});return a},o=function(t,e,a){var r=t.map(function(t){return t.category}),n=t.map(function(t){return t.value}),i=[create_scale(r,d3.scale.ordinal()),create_scale(n,d3.scale.linear())],o=new Thermometers(t,e,a,["category","value"],i);o.add_svg().add_grid().add_thermometers()};build_chart(t,e,a,void 0,n,r,o)}function timeseries(t,e,a,r){var n=function(t){return t},i=function(t){var e=[];t.map(function(t){-1===e.indexOf(t.group)&&e.push(t.group)});var a=d3.time.format("%d/%m/%Y").parse,r=e.map(function(e){return{group:e,values:t.filter(function(t){return t.group===e}).map(function(t){return{value:+t.value,time:a(t.time),variable:t.variable}})}});return r},o=function(t,e,a,r){var n=[],i=[];n=t.map(function(t){return t.values.map(function(t){return t.time})}),n=[].concat.apply([],n),i=t.map(function(t){return t.values.map(function(t){return t.value})}),i=[].concat.apply([],i);var o=function(t,e){},s=[create_scale(n,d3.time.scale()),create_scale(i,d3.scale.linear())],l=new TimeSeries(t,e,a,r,s,o);l.add_svg().add_grid().add_timeseries().add_legend()};build_chart(t,e,a,r,i,n,o)}function tree(t,e,a){var r=function(t){return t},n=function(t){return t},i=function(t,e,a){var r=new Tree(t,e,a);r.add_svg().add_tree()};build_chart(t,e,a,void 0,n,r,i)}function venn(t,e,a){var r=function(t){return t},n=function(t){return t},i=function(t,e,a){var r=new Venn(t,e,a);r.add_svg().add_venn()};build_chart(t,e,a,void 0,n,r,i)}function random_gamma(t,e){var a=d3.random.normal(),r=t-1/3,n=1/Math.sqrt(9*r),i=function(){for(;!(s&l);)var t=a(),i=Math.random(),o=Math.pow(1+n*t,3),s=t>-1/n,l=Math.log(i)<.5*Math.pow(t,2)+r-r*o+r*Math.log(o);return r*o/e};return i}function random_dirichlet(t){var e=t.map(function(t){return random_gamma(t,1)}),a=function(){var t=e.map(function(t){return t()}),a=d3.sum(t),r=t.map(function(t){return t/a});return r};return a}function animated_density(t,e){var a=[],r=random_gamma(5,1);for(i=0;i<5e3;i++)a.push(r());a=a.map(function(t){return Math.round(10*t)/10});var n=Array.apply(null,Array(500)).map(Number.prototype.valueOf,0);a=a.map(function(t){return n[10*t]=n[10*t]+1,{value:t,position:n[10*t]}});var o=function(t,e,a){var r=t.map(function(t){return t.value}),n=t.map(function(t){return t.position}),i=[create_scale(d3.extent(r),d3.scale.linear()),create_scale([0,d3.max(n)+5],d3.scale.linear())],o=new AnimatedDensity(t,e,a,["Random Variable with Gamma Distribution","Occurrences"],i);o.add_svg().add_grid().add_density()};o(a,t,e)}var GlasseyeChart=function(t,e,a,r){var n=this;n.div=t,n.size=e,n.margin=a,n.custom_height=r,n.set_size()};GlasseyeChart.prototype.set_size=function(){var t=this,e=d3.select(t.div).node().getBoundingClientRect();return void 0===t.margin&&(t.margin={top:20,bottom:20,right:20,left:20}),"full_page"===t.size?(t.svg_width=500,t.svg_height=void 0===t.custom_height?300:t.custom_height):"margin"===t.size?(t.svg_width=300,t.svg_height=void 0===t.custom_height?250:t.custom_height):"double_plot_wide"===t.size?(t.svg_width=e.width<600?e.width:600,t.svg_height=void 0===t.custom_height?360:t.custom_height):"double_plot_narrow"===t.size?(t.svg_width=e.width<300?e.width:300,t.svg_height=void 0===t.custom_height?360:t.custom_height):(t.svg_width=300,t.svg_height=void 0===t.custom_height?360:t.custom_height),t.width=t.svg_width-t.margin.left-t.margin.right,t.height=t.svg_height-t.margin.top-t.margin.bottom,t},GlasseyeChart.prototype.add_svg=function(){var t=this;return t.svg=d3.select(t.div).append("svg").attr("class","glasseye_chart").attr("width",t.svg_width).attr("height",t.svg_height),t.chart_area=t.svg.append("g").attr("class","chart_area").attr("transform","translate("+t.margin.left+","+t.margin.top+")"),t};var GridChart=function(t,e,a,r,n,i){var o=this;o.scales=r,o.labels=a,GlasseyeChart.call(o,t,e,n,i),"ordinal"===r[0].scale_type?o.x=o.scales[0].scale_func.rangePoints([0,o.width],1):o.x=o.scales[0].scale_func.range([0,o.width]),"ordinal"===r[1].scale_type?o.y=o.scales[1].scale_func.rangePoints([o.height,0],1):o.y=o.scales[1].scale_func.range([o.height,0]),o.x_axis=d3.svg.axis().scale(o.x).orient("bottom").tickSize(-o.height,0,0).tickPadding(10),o.y_axis=d3.svg.axis().scale(o.y).orient("left").tickSize(-o.width,0,0).tickFormat(uni_format_axis)};GridChart.prototype=Object.create(GlasseyeChart.prototype),GridChart.prototype.add_grid=function(){var t=this,e=t.chart_area.append("g").attr("class","chart_grid x_axis").attr("transform","translate(0,"+t.height+")").call(t.x_axis);return"nonlinear"===t.scales[0].scale_type&&e.selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy",".15em").attr("transform","rotate(-90)"),t.chart_area.append("g").attr("class","chart_grid y_axis").call(t.y_axis),"undefined"!=typeof t.labels&&(t.svg.append("g").attr("class","axis_label").attr("transform","translate("+(t.margin.left+t.width+15)+", "+(t.height+t.margin.top)+") rotate(-90)").append("text").text(t.labels[0]),t.svg.append("g").attr("class","axis_label").attr("transform","translate("+t.margin.left+", "+(t.margin.top-8)+")").append("text").text(t.labels[1])),t};var BarChart=function(t,e,a,r,n,i){var o=this;o.processed_data=t,o.type=void 0===o.processed_data[0].group?"simple":"group";var s=n[0].scale_func.domain(),l=d3.max(s.map(function(t){return t.length})),c=s.length;o.rotate_labels=l>60/c?!0:!1,void 0===i&&(i={top:20,bottom:30,right:20,left:40}),o.rotate_labels===!0&&(i.bottom=5*l),"group"===o.type&&(i.right=80,o.loose_bars=o.processed_data.map(function(t){return t.values.map(function(e){return{value:e.value,group:t.group,label:e.label,y0:e.y0,y1:e.y1}})}),o.loose_bars=[].concat.apply([],o.loose_bars).filter(function(t){return void 0!==t}),o.legend_labels=[],o.loose_bars.forEach(function(t){-1===o.legend_labels.indexOf(t.label)&&o.legend_labels.push(t.label)}),o.num_labels=o.legend_labels.length,o.color=d3.scale.ordinal().range(colorbrewer.RdBu[o.num_labels])),GridChart.call(o,e,a,r,n,i),o.tip=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(t){var e="simple"===o.type?uni_format(t.value):t.label+"<br> size: "+uni_format(t.value);return e}),o.bar_width=o.width/t.length};BarChart.prototype=Object.create(GridChart.prototype),BarChart.prototype.add_bars=function(){var t=this;t.chart_area.call(t.tip),"simple"===t.type?t.chart_area.selectAll(".bar").data(t.processed_data).enter().append("rect").attr("class","bar").attr("x",function(e){return t.x(e.label)-t.bar_width/4}).attr("y",function(e){return t.y(e.value)}).attr("width",t.bar_width/2).attr("height",function(e){return t.height-t.y(e.value)}).on("mouseover",t.tip.show).on("mouseout",t.tip.hide):(t.chart_area.selectAll(".bar").data(t.loose_bars).enter().append("rect").attr("class","bar").attr("x",function(e){return t.x(e.group)-t.bar_width/4}).attr("y",function(e){return t.y(e.y1)}).attr("width",t.bar_width/2).attr("height",function(e){return t.y(e.y0)-t.y(e.y1)}).on("mouseover",t.tip.show).on("mouseout",t.tip.hide).on("click",function(){t.change_layout("to_side")}).style("fill",function(e){return t.color(e.label)}),add_legend(t.svg,t.margin.left+t.width+20,t.margin.top,t.legend_labels.map(function(e,a){return{label:e,colour:t.color(e),"class":"d_"+a}}).reverse())),t.rotate_labels===!0&&t.chart_area.selectAll(".x_axis").selectAll("text").style("text-anchor","end").attr("dx","-1em").attr("dy","-0.8em").attr("transform","rotate(-90)");var e=t.chart_area.selectAll(".y_axis").selectAll("text"),a=+(e[0].length%2===0);return e.style("opacity",function(t,e){return e%2===a?1:0}),t},BarChart.prototype.change_layout=function(t){var e=this;if("to_side"===t){e.preserved_domain=e.y.domain();var a=0;e.processed_data.forEach(function(t){t.values.forEach(function(t){a=t.value>a?t.value:a})}),e.y.domain([e.preserved_domain[0],a]),e.chart_area.selectAll(".y_axis").transition().duration(1e3).call(e.y_axis);var r=e.chart_area.selectAll(".y_axis").selectAll("text"),n=+(r[0].length%2===0);r.style("opacity",function(t,e){return e%2===n?1:0}),e.chart_area.selectAll(".bar").on("click",function(){e.change_layout("to_stack")}).transition().duration(1e3).attr("width",.8*e.bar_width/e.num_labels).attr("y",function(t){return e.y(t.value)}).attr("height",function(t){return e.y(t.y0)-e.y(t.y1)}).attr("x",function(t){var a=e.legend_labels.indexOf(t.label);return e.x(t.group)+a*(.8*e.bar_width/e.num_labels)-.5*e.bar_width+.1*e.bar_width})}else{e.y.domain(e.preserved_domain),e.chart_area.selectAll(".y_axis").transition().duration(1e3).call(e.y_axis);var r=e.chart_area.selectAll(".y_axis").selectAll("text"),n=+(r[0].length%2===0);r.style("opacity",function(t,e){return e%2===n?1:0}),e.chart_area.selectAll(".bar").on("click",function(){e.change_layout("to_side")}).transition().duration(1e3).attr("x",function(t){return e.x(t.group)-e.bar_width/4}).attr("y",function(t){return e.y(t.y1)}).attr("width",e.bar_width/2).attr("height",function(t){return e.y(t.y0)-e.y(t.y1)})}},BarChart.prototype.grumpy=function(t){var e=this;if("simple"===e.type){d3.selectAll(e.div).append("div").attr("id","commentary").style("width",e.width+"px").style("margin-left",e.margin.left+"px");var a=e.processed_data.map(function(t){return t.value}),r=e.processed_data.map(function(t){return t.label}),n=d3.sum(a);if("bayesian"===t){for(var i=a.map(function(t){return t+1}),o=d3.sum(i),s=i.map(function(t){return n*t/o}),l=random_dirichlet(i),c=[],u=0;1e3>u;u+=1)c.push(l());var d=[];r.forEach(function(t,e){r.forEach(function(a,r){d.push({A:e,B:r,A_label:t,B_label:a,diff_dist:c.map(function(t){return t[e]-t[r]})})})}),e.comparisons=d.map(function(t){return{A:t.A,B:t.B,A_label:t.A_label,B_label:t.B_label,diff_dist:t.diff_dist,less_than_zero:d3.sum(t.diff_dist.map(function(t){return 0>t?1:0}))/1e3,more_than_zero:d3.sum(t.diff_dist.map(function(t){return 0>t?0:1}))/1e3}}),s=s.map(function(t,e){return{label:r[e],value:t}}),e.chart_area.insert("g","rect").selectAll(".bar_shrunk").data(s).enter().append("rect").attr("class","bar_shrunk").attr("x",function(t){return e.x(t.label)-e.bar_width/4+15}).attr("y",function(t){return e.y(t.value)}).attr("width",e.bar_width/2).attr("height",function(t){return e.height-e.y(t.value)}).style("fill","steelblue").style("opacity",.2),e.select_mode=0,e.posterior_diff=function(t,a){if(0===e.select_mode)e.select_mode=1,e.A=a;else if(1===e.select_mode){e.select_mode=2,e.B=a,console.log(e.comparisons);var r=e.comparisons.filter(function(t){return t.A===e.A&t.B===e.B})[0];d3.selectAll(e.div).selectAll("#commentary").html("There is a "+d3.format("%")(r.more_than_zero)+" probability that the number of "+r.A_label+" in the population is greater that the number of "+r.B_label)}else console.log("ok")},e.chart_area.selectAll(".bar").on("click",function(t,a){2===e.select_mode&&(e.chart_area.selectAll(".bar").style("fill","steelblue"),e.select_mode=0),d3.select(this).style("fill","#2b506e"),e.posterior_diff(t,a)})}}};var time_linked_venn_parser=function(t){var e=[];t.map(function(t){-1===e.indexOf(t.time)&&e.push(t.time)});var a=d3.time.format("%d/%m/%Y").parse,r=e.map(function(e){return{time:a(e),venns:t.filter(function(t){return t.time===e}).map(function(t){return{size:+t.value,sets:t.group.split("_")}})}});return r},timeseries_parser=function(t){var e=[];t.map(function(t){-1===e.indexOf(t.group)&&e.push(t.group)});var a=d3.time.format("%d/%m/%Y").parse,r=e.map(function(e){return{group:e,values:t.filter(function(t){return t.group===e}).map(function(t){return{value:+t.value,time:a(t.time),variable:t.variable}}).sort(function(t,e){return t.time-e.time})}});return r},time_linked_parser=function(t){var e=[];t.map(function(t){-1===e.indexOf(t.category)&&e.push(t.category)});var a=d3.time.format("%d/%m/%Y").parse,r=e.map(function(e){return{category:e,values:t.filter(function(t){return t.category===e}).map(function(t){return{value:+t.value,time:a(t.time),variable:t.variable}}).sort(function(t,e){return t.time-e.time})}});return r},dial_parser=function(t){var e=[];t.map(function(t){-1===e.indexOf(t.group)&&e.push(t.group)});var a=e.map(function(e){return{group:e,values:t.filter(function(t){return t.group===e}).map(function(t){return{value:+t.value,variable:t.variable,label:t.label}})}});return a},group_label_value_parser=function(t){var e;if(void 0===t[0].group)e=t.map(function(t){return{label:t.label,value:+t.value}});else{var a=[];t.map(function(t){-1===a.indexOf(t.group)&&a.push(t.group)}),e=a.map(function(e){var a=0;return{group:e,values:t.filter(function(t){return t.group===e}).map(function(t){return{value:+t.value,label:t.label,y0:a,y1:a+=+t.value}})}})}return e},uni_format=function(t){var e;return e=t>999?d3.format(".3s")(t):t>100?d3.format(".3r")(t):t>10?Math.round(t)===t?d3.format(".0f")(t):d3.format(".1f")(t):t>1?d3.format(".1f")(t):d3.format(".1f")(t)},uni_format_axis=function(t){var e;return e=t>=1?d3.format("s")(t):d3.format("")(t)},format_millions=function(t){return Math.round(t/1e3)+"m"},format_millions_2d=function(t){return d3.format(".3r")(t/1e3)+"m"},quarter_year=function(t){var e=d3.time.format("%m")(t),a=d3.time.format("%Y")(t),r=parseInt(e)/3;return"Q"+r+" "+a},AnimatedBarChart=function(t,e,a,r,n){var i=this,o={top:50,bottom:80,right:50,left:60};BarChart.call(i,t,e,a,r,n,o),i.bar_width=30,i.y_axis.tickFormat(d3.format("%")).ticks(6),this.x_axis.tickSize(0),i.current_variable="",i.tip=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(t){return d3.format(".1%")(t.value)+" of "+t.category+" have access to a "+i.current_variable})};AnimatedBarChart.prototype=Object.create(BarChart.prototype),AnimatedBarChart.prototype.add_bars=function(){var t=this;t.chart_area.call(t.tip),t.svg.attr("class","glasseye_chart animated_barchart");var e=d3.min(t.processed_data[0].values.map(function(t){return t.time})),a=t.chart_area.selectAll(".bar").data(t.processed_data).enter().append("g").attr("transform",function(e){return"translate("+(t.x(e.category)-.4*t.bar_width)+", 0)"});a.append("rect").attr("class","bar").attr("x",0).attr("y",function(e){return t.y(e.values[0].value)}).attr("width",.8*t.bar_width).attr("height",function(e){return t.height-t.y(e.values[0].value)}).on("mouseover",t.tip.show).on("mouseout",t.tip.hide),t.svg.append("text").attr("class","context").attr("y",t.height+t.margin.top+60).attr("x",t.margin.left+t.width/2).style("text-anchor","middle").text("At "+quarter_year(t.processed_data[0].values[0].time)+" for "+t.processed_data[0].values[0].variable);var r=d3.max(t.x.domain().map(function(t){return t.length}));t.x.domain().length;return 5*r>1.5*t.bar_width&&t.chart_area.selectAll(".x_axis").selectAll("text").style("text-anchor","end").attr("dx","-1em").attr("dy","-0.8em").attr("transform","rotate(-90)"),t.update_bars(e,"PC"),this},AnimatedBarChart.prototype.update_bars=function(t,e){var a=this;a.current_variable=e.toLowerCase();var r=a.processed_data.map(function(a){return{category:a.category,value:a.values.filter(function(a){return a.time.getTime()===t.getTime()&a.variable===e})[0].value}});a.chart_area.selectAll(".bar").data(r).transition().duration(500).attr("y",function(t){return a.y(t.value)}).attr("height",function(t){return a.height-a.y(t.value)}),a.svg.selectAll(".context").text("In "+quarter_year(t)+" for "+e)},AnimatedBarChart.prototype.add_title=function(t,e){var a=this;return a.title=t,a.svg.append("text").attr("class","title").text(t).attr("transform","translate("+(a.margin.left-10)+",20)"),void 0!=e?(a.subtitle=e,a.svg.append("text").attr("class","subtitle").text(e).attr("transform","translate("+(a.margin.left-10)+",35)")):a.subtitle="",this},AnimatedBarChart.prototype.redraw_barchart=function(t){var e=this;d3.select(e.div).selectAll("svg").remove(),e.set_size(),e.bar_width=e.width/e.processed_data.length,e.x=e.scales[0].scale_func.rangePoints([0,e.width],1),console.log(e.width),e.y_axis=d3.svg.axis().scale(e.y).orient("left").tickSize(-e.width,0,0).tickFormat(d3.format("%")).ticks(6),e.add_svg().add_grid().add_bars().add_title(e.title,e.subtitle)};var AnimatedDonut=function(t,e,a){var r=this;margin={top:80,bottom:130,left:30,right:30},GlasseyeChart.call(r,e,a,margin,400),r.processed_data=t;d3.sum(t.map(function(t){return t.values[0].value}));r.current_total=1,r.tip=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(t){return uni_format(t.data.value)+" households<br>"+d3.format(".1%")(t.data.value/r.current_total)+" of the total"});var n=r.width/2;r.arc=d3.svg.arc().outerRadius(n-10).innerRadius(n-70),r.pie=d3.layout.pie().sort(null).value(function(t){return t.value})};AnimatedDonut.prototype=Object.create(GlasseyeChart.prototype),AnimatedDonut.prototype.add_donut=function(){var t=this,e=t.chart_area.append("g").attr("transform","translate("+t.width/2+","+t.height/2+")"),a=d3.scale.ordinal().range(["#98abc5","#8a89a6","#7b6888","#6b486b","#a05d56","#d0743c","#ff8c00"]),r=d3.min(t.processed_data[0].values.map(function(t){return t.time})),n=t.processed_data.map(function(t){return{category:t.category,value:t.values[0].value}});e.call(t.tip),t.donut_arc=e.selectAll(".arc").data(t.pie(n)).enter().append("g").attr("class","arc");return t.donut_path=t.donut_arc.append("path").attr("d",t.arc).attr("class",function(t,e){return"d_"+e+" "+create_class_label("d",t.data.category)}).attr("fill",function(t){return a(t.data.category)}).on("mouseover",function(e,a){t.tip.show(e)}).on("mouseout",function(e,a){t.tip.hide(e)}),t.donut_text=t.donut_arc.append("text").attr("transform",function(e){return"translate("+t.arc.centroid(e)+")"}).attr("dy",".35em").style("text-anchor","middle").text(function(t){return t.endAngle-t.startAngle>.35?t.data.category:""}),t.donut_path.transition().duration(500).attr("fill",function(t,e){return a(t.data.category)}).attr("d",t.arc).each(function(t){this._current=t}),t.svg.append("text").attr("class","context").attr("y",t.height+t.margin.top+70).attr("x",t.margin.left+t.width/2).style("text-anchor","middle"),t.update_donut(r,"No TV"),this},AnimatedDonut.prototype.update_donut=function(t,e){function a(t){var e=d3.interpolate(this._current,t);return this._current=e(0),function(t){return r.arc(e(t))}}var r=this,n=(d3.scale.ordinal().range(["#98abc5","#8a89a6","#7b6888","#6b486b","#a05d56","#d0743c","#ff8c00"]),r.processed_data.map(function(a){return{category:a.category,value:a.values.filter(function(a){return a.time.getTime()===t.getTime()&a.variable===e})[0].value}}));r.current_total=d3.sum(n.map(function(t){return t.value})),r.donut_path.data(r.pie(n)).transition().duration(200).attrTween("d",a),r.donut_text.data(r.pie(n)).transition().duration(200).attr("transform",function(t){return"translate("+r.arc.centroid(t)+")"}).attr("dy",".35em").style("text-anchor","middle").text(function(t){return t.data.category}),r.svg.selectAll(".context").text("In "+quarter_year(t)+" for "+e)},AnimatedDonut.prototype.add_title=function(t,e){var a=this;return a.title=t,a.svg.append("text").attr("class","title").text(t).attr("y",20).attr("x",a.margin.left+a.width/2).style("text-anchor","middle"),void 0!=e?(a.subtitle=e,a.svg.append("text").attr("class","subtitle").text(e).attr("y",35).attr("x",a.margin.left+a.width/2).style("text-anchor","middle")):a.subtitle="",this},AnimatedDonut.prototype.redraw_donut=function(t){var e=this;d3.select(e.div).selectAll("svg").remove(),d3.select(e.div).selectAll("#venn_context").remove(),e.set_size();var a=e.width/2;e.arc=d3.svg.arc().outerRadius(a-10).innerRadius(a-70),e.add_svg().add_donut().add_title(e.title,e.subtitle)};var AnimatedVenn=function(t,e,a){var r=this;margin={top:60,bottom:0,left:5,right:5},GlasseyeChart.call(r,e,a,margin,250),r.processed_data=t,r.venn_chart=venn.VennDiagram().width(r.width).height(r.height),r.tip=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(t){return d3.format(".3n")(t.size)}),r.interactive_text=function(t,e){function a(t,e){return t+e}var n,i=t.sets[0],o=t.size,s=r.chart_area.selectAll("g")[0],l=s.map(function(t){return 2==t.__data__.sets.length?-t.__data__.size:t.__data__.size}),c=l.reduce(a,0);if(1==t.sets.length)n=i+" was in "+uni_format(1e3*o)+" households making up "+d3.format(",.1%")(o/c)+" of all VOD subscribing households.";else if(2==t.sets.length){var u=t.sets[0],d=t.sets[1];s.filter(function(t){return 1===t.__data__.sets.length&t.__data__.sets[0]===u})[0].__data__.size,s.filter(function(t){return 1===t.__data__.sets.length&t.__data__.sets[0]===d})[0].__data__.size;n="There were "+uni_format(1e3*o)+" households that subscribe to both "+u+" and "+d+" ("+d3.format(",.1%")(o/c)+" of all VOD subscribing households.)"}else n="There were "+uni_format(1e3*o)+" households that subscribe to all three. That's "+d3.format(",.1%")(o/c)+" of all VOD subscribing households.";return n}};AnimatedVenn.prototype=Object.create(GlasseyeChart.prototype),AnimatedVenn.prototype.add_venn=function(){var t=this,e=new Date("March 31, 2014 00:00:00"),a=t.processed_data.filter(function(t){return t.time.getTime()===e.getTime();
})[0].venns;t.chart_area.datum(a).call(t.venn_chart),t.svg.append("text").attr("class","context").attr("y",40).attr("x",t.margin.left+t.width/2).style("text-anchor","middle").text("In Q1 2014");var r=d3.select(t.div).append("div").attr("id","venn_context");return r.append("div").attr("id","commentary").style("font-size","11px"),t.chart_area.selectAll("g").on("mouseover",function(e,a){t.chart_area.selectAll(".venn-area").selectAll("path").style("stroke-opacity",0),venn.sortAreas(t.chart_area,e);var r=d3.select(this);r.select("path").transition().duration(500).style("stroke-opacity",1);var n=d3.selectAll("#commentary").html();d3.selectAll("#commentary").html(t.interactive_text(e,n))}).on("mouseout",function(t,e){var a=d3.select(this);a.select("path").transition().duration(500).style("stroke-opacity",0)}),this},AnimatedVenn.prototype.update_venn=function(t,e){var a=this,r=a.processed_data.filter(function(e){return e.time.getTime()===t.getTime()})[0].venns;return a.chart_area.datum(r).call(a.venn_chart),a.chart_area.selectAll(".venn-area").selectAll("path").style("stroke-opacity",0),a.chart_area.selectAll(".venn-sets-"+e).selectAll("path").style("stroke-opacity",1),d3.selectAll("#commentary").html(""),a.svg.selectAll(".context").text("In "+quarter_year(t)+" "),this},AnimatedVenn.prototype.add_title=function(t){var e=this;return e.title=t,e.svg.append("text").attr("class","title").text(t).attr("y",20).attr("x",e.margin.left+e.width/2).style("text-anchor","middle"),this},AnimatedVenn.prototype.redraw_venn=function(t){var e=this;d3.select(e.div).selectAll("svg").remove(),d3.select(e.div).selectAll("#venn_context").remove(),e.set_size(),e.venn_chart=venn.VennDiagram().width(e.width).height(e.height),e=e.add_svg().add_venn().add_title(e.title,e.subtitle)};var Donut=function(t,e,a){margin={top:5,bottom:5,left:5,right:5},GlasseyeChart.call(this,e,a,margin),this.processed_data=t;var r=d3.sum(t.map(function(t){return t.value}));this.tip=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(t){return t.data.label+"<br><br>"+t.data.value+"<br><br>"+d3.format("%")(t.data.value/r)});var n=this.height/2;this.arc=d3.svg.arc().outerRadius(n-10).innerRadius(n-70),this.pie=d3.layout.pie().sort(null).value(function(t){return t.value})};Donut.prototype=Object.create(GlasseyeChart.prototype),Donut.prototype.add_donut=function(){var t=this.chart_area.append("g").attr("transform","translate("+this.width/2+","+this.height/2+")"),e=d3.scale.ordinal().range(["#98abc5","#8a89a6","#7b6888","#6b486b","#a05d56","#d0743c","#ff8c00"]);t.call(this.tip);var a=t.selectAll(".arc").data(this.pie(this.processed_data)).enter().append("g").attr("class","arc");a.append("path").attr("d",this.arc).style("fill",function(t){return e(t.data.label)}).on("mouseover",this.tip.show).on("mouseout",this.tip.hide);var r=this.arc;a.append("text").attr("transform",function(t){return"translate("+r.centroid(t)+")"}).attr("dy",".35em").style("text-anchor","middle").text(function(t){return t.endAngle-t.startAngle>.35?t.data.label:""})};var Force=function(t,e,a){var r="full_page"===a?{top:5,bottom:5,left:100,right:100}:{top:5,bottom:5,left:50,right:50};GlasseyeChart.call(this,e,a,r,300),this.processed_data=t,this.force=d3.layout.force().charge(-120).linkDistance(30).size([this.width,this.height]),this.tip=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(t){return t.name})};Force.prototype=Object.create(GlasseyeChart.prototype),Force.prototype.add_force=function(){var t=d3.scale.category20();this.chart_area.call(this.tip),this.force.nodes(this.processed_data.nodes).links(this.processed_data.links).start();var e=this.chart_area.selectAll(".forcelink").data(this.processed_data.links).enter().append("line").attr("class","forcelink").style("stroke-width",function(t){return Math.sqrt(t.value)}),a=this.chart_area.selectAll(".forcenode").data(this.processed_data.nodes).enter().append("circle").attr("class","forcenode").attr("r",8).style("fill",function(e){return t(e.group)}).call(this.force.drag).on("mouseover",this.tip.show).on("mouseout",this.tip.hide);this.force.on("tick",function(){e.attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y}),a.attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y})})};var Gantt=function(t,e,a,r){this.div=e,this.processed_data=t,GridChart.call(this,e,a,["Time","Tasks"],r,{top:20,bottom:80,left:80,right:20}),this.tip=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(t){return Math.floor((t.end-t.start)/864e5)+" days"}),this.bar_width=this.width/t.length};Gantt.prototype=Object.create(GridChart.prototype),Gantt.prototype.add_tasks=function(){var t=this.x,e=this.y,a=this.bar_width;return this.chart_area.call(this.tip),this.chart_area.selectAll(".task").data(this.processed_data).enter().append("rect").attr("class","task").attr("y",function(t){return e(t.task)-a/6}).attr("x",function(e){return t(e.start)}).attr("height",this.bar_width/3).attr("width",function(e){return t(e.end)-t(e.start)}).on("mouseover",this.tip.show).on("mouseout",this.tip.hide),this};var LinePlot=function(t,e,a,r,n){GridChart.call(this,e,a,r,n),this.processed_data=t,this.margin.left=4,this.y_axis.tickFormat(""),this.tip=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(t){return d3.format(".3n")(t.y)});var i=this.x,o=this.y;this.line=d3.svg.line().x(function(t){return i(t.x)}).y(function(t){return o(t.y)})};LinePlot.prototype=Object.create(GridChart.prototype),LinePlot.prototype.add_line=function(){this.chart_area.call(this.tip),this.chart_area.append("path").datum(this.processed_data).attr("class","line").attr("d",this.line);var t=this.x,e=this.y;return this.chart_area.selectAll("line_points").data(this.processed_data).enter().append("circle").attr("class","line_points").attr("cx",function(e){return t(e.x)}).attr("cy",function(t){return e(t.y)}).attr("r",10).attr("opacity",0).on("mouseover",this.tip.show).on("mouseout",this.tip.hide),this};var ScatterPlot=function(t,e,a,r,n){GridChart.call(this,e,a,r,n),this.processed_data=t,this.tip=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(t){return d3.format(".3n")(t.y)});this.x,this.y};ScatterPlot.prototype=Object.create(GridChart.prototype),ScatterPlot.prototype.add_points=function(){this.chart_area.call(this.tip),this.chart_area.append("path").datum(this.processed_data).attr("class","line").attr("d",this.line);var t=this.x,e=this.y;return this.chart_area.selectAll("points").data(this.processed_data).enter().append("circle").attr("class","points").attr("cx",function(e){return t(e.x)}).attr("cy",function(t){return e(t.y)}).attr("r",3).on("mouseover",this.tip.show).on("mouseout",this.tip.hide),this};var Thermometers=function(t,e,a,r,n){var i=this,o={top:50,bottom:80,right:50,left:50};BarChart.call(i,t,e,a,r,n,o),i.bar_width=i.width/7,i.y_axis.tickFormat(d3.format("0%")).ticks(6).tickSize(6)};Thermometers.prototype=Object.create(BarChart.prototype),Thermometers.prototype.add_thermometers=function(){var t=this;t.chart_area.call(t.tip),t.svg.attr("class","glasseye_chart thermometers");var e=t.chart_area.selectAll(".thermometer").data(t.processed_data).enter().append("g").attr("class","thermometer").attr("transform",function(e){return"translate("+(t.x(e.category)-t.bar_width/4)+", 0)"}),a=t.bar_width/2,r=.8;return e.append("rect").attr("class","glass").attr("width",a).attr("height",t.height),e.append("rect").attr("class","glass-gap").attr("x",a*(1-r)/2).attr("width",a*r).attr("height",t.height),e.append("text").attr("class","therm_reading").text(d3.format("%")(0)).attr("transform","translate("+t.bar_width+", "+t.height/2+")"),e.append("rect").attr("class","mercury").attr("x",t.bar_width/8).attr("y",t.y(0)).attr("width",t.bar_width/4).attr("height",t.height-t.y(0)),t.svg.append("text").attr("class","context").attr("y",t.height+t.margin.top+60).attr("x",t.margin.left+t.width/2).style("text-anchor","middle"),this},Thermometers.prototype.update_thermometers=function(t,e){var a=this;a.chart_area.selectAll(".mercury").transition().duration(500).attr("y",function(r){var n=r.values.filter(function(a){return a.time.getTime()===t.getTime()&a.variable===e});return a.y(n[0].value)}).attr("height",function(r){var n=r.values.filter(function(a){return a.time.getTime()===t.getTime()&a.variable===e});return a.height-a.y(n[0].value)}),a.chart_area.selectAll(".therm_reading").text(function(a){var r=a.values.filter(function(a){return a.time.getTime()===t.getTime()&a.variable===e});return d3.format("%")(r[0].value)}),a.svg.selectAll(".context").text("In "+quarter_year(t)+" for "+e+" households")},Thermometers.prototype.add_title=function(t,e){var a=this;return a.title=t,a.svg.append("text").attr("class","title").text(t).attr("y",20).attr("x",a.margin.left+a.width/2).style("text-anchor","middle"),void 0!=e?(a.subtitle=e,a.svg.append("text").attr("class","subtitle").text(e).attr("y",35).attr("x",a.margin.left+a.width/2).style("text-anchor","middle")):a.subtitle="",this},Thermometers.prototype.redraw_thermometer=function(t){var e=this;d3.select(e.div).selectAll("svg").remove(),e.set_size(),e.bar_width=e.width/7,e.x=e.scales[0].scale_func.rangePoints([0,e.width],1),e.add_svg().add_grid().add_thermometers().add_title(e.title,e.subtitle)};var TimeSeries=function(t,e,a,r,n,i){var o=this,s={top:50,bottom:80,right:30,left:130};GridChart.call(o,e,a,void 0,n,s),o.processed_data=t,o.tooltip_function=i,o.y_axis.ticks(4).tickFormat(uni_format_axis).tickSize(0),o.x_axis.tickFormat(d3.time.format("%Y")).ticks(d3.time.month,3).tickSize(6,0),o.tip=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(t){return quarter_year(t.time)+"<br>"+t.group+"<br>"+("share"===t.variable?d3.format(".1%")(t.value):uni_format(t.value))}),o.line=d3.svg.line().x(function(t){return o.x(t.time)}).y(function(t){return o.y(t.value)}),o.area=d3.svg.area().x(function(t){return o.x(t.time)}).y0(o.height).y1(function(t){return o.y(t.value)}),o.area_stacked=d3.svg.area().x(function(t){return o.x(t.time)}).y0(function(t){return o.y(t.y0)}).y1(function(t){return o.y(t.y0+t.y)}),o.stack=d3.layout.stack().x(function(t){return t.time}).y(function(t){return t.value}).values(function(t){return t.values}).order("reverse"),o.color=d3.scale.ordinal().range(colorbrewer.RdYlBu[o.processed_data.length])};TimeSeries.prototype=Object.create(GridChart.prototype),TimeSeries.prototype.add_timeseries=function(){var t=this;t.chart_area.call(t.tip),t.filtered_data=t.processed_data.map(function(t){return{group:t.group,values:t.values.filter(function(t){return"absolute"===t.variable})}}),t.chart_area.selectAll(".groups").data(t.filtered_data).enter().append("path").attr("stroke",function(e){return t.color(e.group)}).attr("class",function(t,e){return"timeseries_line c_"+e+" "+create_class_label("c",t.group)}).attr("d",function(e){return t.line(e.values)}),t.chart_area.selectAll(".timeseries_area").data(t.filtered_data).enter().append("path").attr("class",function(t,e){return"timeseries_area d_"+e+" "+create_class_label("d",t.group)}).attr("d",function(e){return t.area(e.values)}).style("opacity",0),t.create_linepoints("absolute"),t.chart_area.selectAll("g.x_axis g.tick line").attr("y2",function(t,e){return e%4?2:6});var e=(t.x.domain()[1]-t.x.domain()[0])/864e5;return t.chart_area.selectAll("g.x_axis g.tick text").text(function(t,a){return a%4?e>1200?"":"Q"+(a%4+1):d3.time.format("%Y")(t)}),"undefined"!=typeof t.labels&&t.chart_area.append("g").attr("class","axis_label").attr("transform","translate(0, "+(t.height+t.margin.top)+") rotate(-90)").append("text").text(t.labels[0]),this},TimeSeries.prototype.create_linepoints=function(t){var e=this,a=e.filtered_data.map(function(t){return t.values.map(function(e){return{time:e.time,value:e.value,group:t.group,variable:e.variable,y:e.y,y0:e.y0}})});a=[].concat.apply([],a).filter(function(t){return void 0!==t}),e.chart_area.selectAll(".line_points").data(a).enter().append("g").attr("class","line_point_group").append("circle").attr("class","line_points").attr("cx",function(t){return e.x(t.time)}).attr("cy",function(a){return"share"===t?e.y(a.y0+a.y):e.y(a.value)}).attr("r",10).on("mouseover",function(t){e.tooltip_function(t.time,t.group),e.tip.show(t)}).on("mouseout",e.tip.hide)},TimeSeries.prototype.flip_variable=function(t,e){var a=this;a.current_y_axis=t,e=void 0===e?1e3:e,a.filtered_data=a.processed_data.map(function(e){return{group:e.group,values:e.values.filter(function(e){return e.variable===t})}}),a.y.domain(minmax_across_groups(a.processed_data,t));var r=a.area,n=0;return"absolute"===t?a.y_axis.tickFormat(uni_format_axis).ticks(6):"share"===t?(a.y_axis.tickFormat(d3.format("0%")).ticks(6),a.filtered_data=a.stack(a.filtered_data),a.y.domain([0,1]),r=a.area_stacked,n=1):a.y_axis.tickFormat(d3.format(".2n")).ticks(6),a.chart_area.selectAll(".y_axis").call(a.y_axis),a.chart_area.selectAll(".timeseries_line").data(a.filtered_data).transition().duration(e).attr("d",function(e){return"share"===t?a.line(e.values.map(function(t){return{time:t.time,value:t.y+t.y0}})):a.line(e.values)}),a.chart_area.selectAll(".timeseries_area").data(a.filtered_data).transition().duration(e).attr("d",function(t){return r(t.values)}).style("opacity",n),a.chart_area.selectAll(".line_points").remove(),a.create_linepoints(t),a.update_line_labels(t),this},TimeSeries.prototype.add_legend=function(){var t=this;return t.processed_data.length>1&&add_legend(t.svg,0,t.margin.top,t.processed_data.map(function(e,a){return{label:e.group,colour:t.color(e.group),"class":create_class_label("d",e.group)}})),this},TimeSeries.prototype.add_title=function(t,e){var a=this;return a.title=t,a.svg.append("text").attr("class","title").text(t).attr("transform","translate("+(a.margin.left-10)+",20)"),void 0!=e&&(a.subtitle=e,a.svg.append("text").attr("class","subtitle").text(e).attr("transform","translate("+(a.margin.left-10)+",35)")),this},TimeSeries.prototype.add_line_labels=function(){var t=this;t.chart_area.attr("transform","translate(50,50)");var e=t.x.domain()[1].getTime(),a=t.processed_data.map(function(t){return{group:t.group,value:t.values.filter(function(t){return t.time.getTime()===e&&"absolute"===t.variable})[0].value}});return t.chart_area.selectAll(".line_labels").data(a).enter().append("text").attr("class","line_labels").attr("x",t.width+10).attr("y",function(e){return t.y(e.value)}).text(function(t){return t.group}),this},TimeSeries.prototype.update_line_labels=function(t){var e=this,a=e.x.domain()[1].getTime(),r=e.processed_data.map(function(e){return{group:e.group,value:e.values.filter(function(e){return e.time.getTime()===a&&e.variable===t})[0].value}});e.chart_area.selectAll(".line_labels").transition().duration(1e3).attr("y",function(t,a){return e.y(r[a].value)})},TimeSeries.prototype.redraw_timeseries=function(t){var e=this;d3.select(e.div).selectAll("svg").remove(),e.set_size(),"ordinal"===e.scales[0].scale_type?e.x=e.scales[0].scale_func.rangePoints([0,e.width],1):e.x=e.scales[0].scale_func.range([0,e.width]);var a=void 0===e.current_y_axis?"absolute":e.current_y_axis;e.y.domain(minmax_across_groups(e.processed_data,a)),e.add_svg().add_grid().add_timeseries().add_legend().add_title(e.title,e.subtitle).flip_variable(a,0)};var Tree=function(t,e,a){var r="full_page"===a?{top:5,bottom:5,left:100,right:100}:{top:5,bottom:5,left:50,right:50};GlasseyeChart.call(this,e,a,r,300),this.processed_data=t;var n=d3.layout.tree().size([this.height,this.width]);this.nodes=n.nodes(t),this.links=n.links(this.nodes),this.diagonal=d3.svg.diagonal().projection(function(t){return[t.y,t.x]})};Tree.prototype=Object.create(GlasseyeChart.prototype),Tree.prototype.add_tree=function(){var t=(this.chart_area.selectAll(".treelink").data(this.links).enter().append("path").attr("class","treelink").attr("d",this.diagonal),this.chart_area.selectAll(".treenode").data(this.nodes).enter().append("g").attr("class","treenode").attr("transform",function(t){return"translate("+t.y+","+t.x+")"}));t.append("circle").attr("r",4.5);var e="full_page"===this.size?20:10;t.append("text").attr("dx",function(t){return t.children?-8:8}).attr("dy",3).style("text-anchor",function(t){return t.children?"end":"start"}).text(function(t){return abbrev(t.name,e)})};var Venn=function(t,e,a){margin={top:5,bottom:5,left:5,right:5},GlasseyeChart.call(this,e,a,margin),this.processed_data=t,this.venn_chart=venn.VennDiagram().width(this.width).height(this.height)};Venn.prototype=Object.create(GlasseyeChart.prototype),Venn.prototype.add_venn=function(){this.chart_area.datum(this.processed_data).call(this.venn_chart)};var Dial=function(t,e,a,r){this.processed_data=t;var n=.55;GlasseyeChart.call(this,e,a);r[0].scale_func.domain();this.dial_radius=n*this.width/2,this.dial_scale=r[0].scale_func.range([0,359]),this.dial_scale.domain([-.3,.1]).clamp(!0),this.current_angle=this.dial_scale(-.123);var i=d3.range(0,360,30),o=this.dial_scale;this.dial_face_data=i.map(function(t){return{angle:t,value:o.invert((t+180)%360)}})};Dial.prototype=Object.create(GlasseyeChart.prototype),Dial.prototype.add_dial=function(){function t(){var t=d3.interpolate(0,e.current_angle);return function(e){return"rotate("+t(e)+")"}}var e=this,a=e.chart_area.append("g").attr("transform","translate("+e.width/2+", "+e.height/2.5+")");a.append("svg").attr("width",e.dial_radius).attr("height",e.dial_radius).append("circle").attr("r",e.dial_radius).style("fill","#990000"),a.append("circle").attr("class","dial_face").attr("r",e.dial_radius),a.append("circle").attr("class","dial_seg").attr("r",.4*e.dial_radius).attr("fill","black"),a.append("circle").attr("class","dial_centre").attr("r",.05*e.dial_radius),a.append("line").attr("class","dial_hand").attr("x2",.7*e.dial_radius).transition().duration(this.current_angle/360*5e3).attrTween("transform",t);var r=a.selectAll(".dial_ticks").data(e.dial_face_data).enter().append("g").attr("transform",function(t){return"rotate("+t.angle+") translate("+-e.dial_radius+", 0) "});return r.append("line").attr("x2",7),r.append("text").style("text-anchor","middle").attr("class","dial_tick_labels").attr("dy",".35em").attr("transform",function(t){return t.angle<270&&t.angle>90,"translate(20,0) rotate(-90) "}).text(function(t){return d3.format(",.0f")(100*t.value)}),e.chart_area.append("text").attr("class","dial_counter").attr("transform","translate(250,"+(e.height/2.5+7)+")").text("").style("text-anchor","end").transition().delay(this.current_angle/360*5e3).text("0%"),e},Dial.prototype.update_dial=function(t,e){function a(){var t=d3.interpolate(o,i);return function(e){return"rotate("+t(e)+")"}}var r=this,n=r.processed_data.filter(function(e){return e.group===t})[0].values.filter(function(t){return t.variable===e})[0],i=r.dial_scale(n.value),o=r.current_angle;return r.chart_area.selectAll(".dial_hand").transition().duration(1e3).attrTween("transform",a),r.chart_area.selectAll(".dial_counter").transition().delay(1e3).text(d3.format("%")(n.value)),r.current_angle=i,r},Dial.prototype.add_title=function(t){var e=this;return e.svg.append("text").attr("class","title").text(t).style("text-anchor","middle").attr("transform","translate("+(e.margin.left+e.width/2)+",20)"),this},Dial.prototype.add_subtitle=function(t){var e=this;return e.svg.append("text").attr("class","subtitle").text(t).style("text-anchor","middle").attr("transform","translate("+(e.margin.left+e.width/2)+",40)"),this};var LogisticCurve=function(t){this.formula=t.replace(/ /g,"");var e=this.formula.split("="),a=e[0],r=e[1].split("+"),n={response:a,explanatory:r.map(function(t){var e=t.split("*"),a=parseFloat(e[0]),r=e[1].split("["),n=r[0],i=r[1].slice(0,-1).split(",").map(function(t){return parseFloat(t)});return{coef:a,variable:n,variable_range:i}})};console.log(n);d3.svg.line().x(function(t){return t.x}).y(function(t){return t.y}).interpolate("basis")},AnimatedDensity=function(t,e,a,r,n,i){var o=this;o.processed_data=t,GridChart.call(o,e,a,r,n,i)};AnimatedDensity.prototype=Object.create(GridChart.prototype),AnimatedDensity.prototype.add_density=function(){var t=this,e=d3.max([t.width/(10*t.x.domain()[1]),t.height/t.y.domain()[1]])+2;t.chart_area.selectAll("rect").data(t.processed_data).enter().append("circle").attr("class","block").attr("r",e).attr("cx",function(e){return t.x(e.value)}).attr("cy",0).attr("opacity",0).transition().duration(2500).delay(function(t,e){return 40*e}).attr("cy",function(e){return t.height-e.position*t.height/t.y.domain()[1]}).attr("opacity",1)};
